# –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

## –¶–µ–ª—å

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–∏–≥–ª–∞—à–∞—é—Ç –¥—Ä—É–∑–µ–π –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ –∏ –ø–æ–ª—É—á–∞—é—Ç –±–æ–Ω—É—Å–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã. –≠—Ç–æ –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–π –∫–∞–Ω–∞–ª –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –±–µ–∑ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤.

---

## –ú–µ—Ö–∞–Ω–∏–∫–∞

1. –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É:
   ```
   https://t.me/Photo_2_StickerBot?start=ref_42269230
   ```
   –≥–¥–µ `42269230` ‚Äî telegram_id –ø—Ä–∏–≥–ª–∞—à–∞—é—â–µ–≥–æ

2. –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ ‚Üí –±–æ—Ç –ø–∞—Ä—Å–∏—Ç `ref_{telegram_id}` –∏–∑ payload ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `referred_by` –≤ —Ç–∞–±–ª–∏—Ü—É users

3. –ù–∞–≥—Ä–∞–¥–∞ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## –ú–æ–¥–µ–ª—å –Ω–∞–≥—Ä–∞–¥ (–í–∞—Ä–∏–∞–Ω—Ç –í ‚Äî –≥–∏–±—Ä–∏–¥)

| –°–æ–±—ã—Ç–∏–µ | –ü—Ä–∏–≥–ª–∞—à–∞—é—â–∏–π –ø–æ–ª—É—á–∞–µ—Ç | –ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π –ø–æ–ª—É—á–∞–µ—Ç |
|---------|----------------------|---------------------|
| –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–∞ | +1 –∫—Ä–µ–¥–∏—Ç | +1 –∫—Ä–µ–¥–∏—Ç (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π) |
| –ü–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ | +2 –∫—Ä–µ–¥–∏—Ç–∞ | ‚Äî |

**–ë–µ–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –æ—Ç –ø–æ–∫—É–ø–æ–∫** ‚Äî –ø—Ä–æ—â–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è, –º–µ–Ω—å—à–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π.

---

## –°—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö

### –ù–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ `users`

```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS referred_by UUID REFERENCES users(id);
ALTER TABLE users ADD COLUMN IF NOT EXISTS referral_count INT DEFAULT 0;
ALTER TABLE users ADD COLUMN IF NOT EXISTS referral_earnings INT DEFAULT 0;
```

### –¢–∞–±–ª–∏—Ü–∞ `referral_rewards` (–ª–æ–≥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π)

```sql
CREATE TABLE referral_rewards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  referrer_id UUID NOT NULL REFERENCES users(id),
  referred_id UUID NOT NULL REFERENCES users(id),
  reward_type TEXT NOT NULL, -- 'registration', 'first_purchase'
  credits_awarded INT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_referral_rewards_referrer ON referral_rewards(referrer_id);
CREATE INDEX idx_referral_rewards_referred ON referral_rewards(referred_id);
```

---

## UX –≤ –±–æ—Ç–µ

### –ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É

–ö–Ω–æ–ø–∫–∞ "üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞" –≤ –º–µ–Ω—é –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞ `/referral`.

–ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:
```
üéÅ –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ –∏ –ø–æ–ª—É—á–∏ –±–æ–Ω—É—Å!

–¢–≤–æ—è —Å—Å—ã–ª–∫–∞:
https://t.me/Photo_2_StickerBot?start=ref_42269230

–ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞:
‚Ä¢ +1 –∫—Ä–µ–¥–∏—Ç –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
‚Ä¢ +2 –∫—Ä–µ–¥–∏—Ç–∞ –ø—Ä–∏ –µ–≥–æ –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–µ

üìä –¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ: 5 –¥—Ä—É–∑–µ–π
–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: 12 –∫—Ä–µ–¥–∏—Ç–æ–≤
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞:**
- –ü—Ä–∏–≥–ª–∞—à–∞—é—â–µ–º—É: "üéâ –í–∞—à –¥—Ä—É–≥ @username –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è! +1 –∫—Ä–µ–¥–∏—Ç"
- –ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–º—É: –æ–±—ã—á–Ω—ã–π onboarding

**–ü—Ä–∏ –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–µ —Ä–µ—Ñ–µ—Ä–∞–ª–∞:**
- –ü—Ä–∏–≥–ª–∞—à–∞—é—â–µ–º—É: "üí∞ –í–∞—à –¥—Ä—É–≥ @username –∫—É–ø–∏–ª –∫—Ä–µ–¥–∏—Ç—ã! +2 –±–æ–Ω—É—Å–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–∞"

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å UTM

–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π payload `ref_{telegram_id}` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ `parseStartPayload()`:
- `source` = `"ref"`
- `medium` = `null`
- `campaign` = `"{telegram_id}"`

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∏–¥–µ—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫ –≤ –æ–±—â–µ–π UTM-–∞–Ω–∞–ª–∏—Ç–∏–∫–µ.

---

## –ó–∞—â–∏—Ç–∞ –æ—Ç –∞–±—å—é–∑–∞

- –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–∏–Ω —Ä–µ—Ñ–µ—Ä–µ—Ä (–Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å `referred_by`)
- –†–µ—Ñ–µ—Ä–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–Ω–æ–≤—ã–º** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (existing users –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)
- –°–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª –∑–∞–ø—Ä–µ—â—ë–Ω (`referrer.telegram_id !== new_user.telegram_id`)
- –ú–∞–∫—Å–∏–º—É–º 50 —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- Reward –∑–∞ –ø–µ—Ä–≤—É—é –ø–æ–∫—É–ø–∫—É ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–∫—É–ø–∫–∞ >= –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞

---

## –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

### –¢–æ–ø —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤
```sql
SELECT
  u.username,
  u.telegram_id,
  u.referral_count,
  u.referral_earnings
FROM users u
WHERE u.referral_count > 0
ORDER BY u.referral_count DESC
LIMIT 20;
```

### –ö–æ–Ω–≤–µ—Ä—Å–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
```sql
SELECT
  COUNT(*) as total_referred,
  COUNT(*) FILTER (WHERE has_purchased) as paid_referred,
  ROUND(100.0 * COUNT(*) FILTER (WHERE has_purchased) / NULLIF(COUNT(*), 0), 1) as conversion_pct
FROM users
WHERE referred_by IS NOT NULL;
```

### –õ–æ–≥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π
```sql
SELECT
  rr.reward_type,
  COUNT(*) as count,
  SUM(rr.credits_awarded) as total_credits
FROM referral_rewards rr
WHERE rr.created_at > now() - interval '30 days'
GROUP BY rr.reward_type;
```

---

## –ß–µ–∫–ª–∏—Å—Ç

- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è: –∫–æ–ª–æ–Ω–∫–∏ `referred_by`, `referral_count`, `referral_earnings` –≤ users
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è: —Ç–∞–±–ª–∏—Ü–∞ `referral_rewards`
- [ ] –ü–∞—Ä—Å–∏–Ω–≥ `ref_{telegram_id}` –≤ `parseStartPayload()`
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ +1 –∫—Ä–µ–¥–∏—Ç —Ä–µ—Ñ–µ—Ä–µ—Ä—É –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- [ ] –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ +2 –∫—Ä–µ–¥–∏—Ç–∞ —Ä–µ—Ñ–µ—Ä–µ—Ä—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–µ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
- [ ] –ö–æ–º–∞–Ω–¥–∞ `/referral` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- [ ] –ö–Ω–æ–ø–∫–∞ "üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞" –≤ –º–µ–Ω—é
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–µ—Ä—É
- [ ] –ó–∞—â–∏—Ç–∞ –æ—Ç –∞–±—å—é–∑–∞ (–ª–∏–º–∏—Ç—ã, –ø—Ä–æ–≤–µ—Ä–∫–∏)
