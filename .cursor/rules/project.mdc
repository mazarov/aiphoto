# AI Photo Bot — Project Rules

## Перед деплоем (ОБЯЗАТЕЛЬНО)

1. **Проверить билд локально:**
   ```bash
   npm run build
   ```
   Если есть ошибки TypeScript — исправить до коммита.

2. **При изменении select запросов** — проверить что все нужные поля включены в select.

3. **Перед каждым релизом / деплоем:**
   - Проверить, что новые изменения не ломают существующую логику (стили, платежи)
   - Оценить пересечения с текущими callback, handler'ами и flow
   - Остановиться и дождаться явного подтверждения от пользователя
   - Без подтверждения — не коммитить и не пушить

## Git — КРИТИЧНО

**Этот проект — отдельный репозиторий: `https://github.com/mazarov/aiphoto`**

- Push ТОЛЬКО в `mazarov/aiphoto` — НЕ в photo2sticker-bot
- Коммиты делаются ВНУТРИ `aiphoto/` директории
- После push — обновить ссылку в родительском репо photo2sticker-bot
- **Если не уверен куда пушить — СПРОСИ**

## Работа с кодом

- После создания SQL миграции — напомнить пользователю выполнить в Supabase
- Новые фичи документировать перед реализацией
- Формат коммитов: `type: description` (feat, fix, docs, refactor)
- Пушить сразу после коммита

## Деплой

### Архитектура
Проект работает на **Dockhost** — 3 контейнера:
- `Dockerfile.api` → API бот (Telegram webhook / long polling)
- `Dockerfile.worker` → Воркер генерации фото
- `Dockerfile.support` → Саппорт бот

**Нет rembg контейнера** — удаление фона не используется.

### Прод (main)
- Деплой автоматический при пуше в `main`
- После `git push` дождаться автодеплоя

## Структура проекта

```
src/
├── index.ts        — основной бот (Telegraf)
├── worker.ts       — воркер генерации фото
├── support-bot.ts  — саппорт бот
├── config.ts       — конфигурация
└── lib/
    ├── alerts.ts   — алерты и нотификации
    ├── supabase.ts — клиент Supabase
    ├── telegram.ts — утилиты Telegram API (sendPhoto)
    ├── texts.ts    — локализация (ru/en)
    ├── app-config.ts — конфигурация из БД
    └── image-utils.ts — утилиты обработки изображений

sql/            — миграции (нумерация 001, 002...)
```

## Отличия от photo2sticker

- Результат — **фото** (sendPhoto), не стикер (sendSticker)
- **Нет** удаления фона (rembg, chromaKey, Pixian)
- **Нет** стикер-специфики (512x512, WebP, стикерпаки, trim)
- **Есть** выбор модели, формата (aspect ratio), качества
- Supabase — та же инстанция, таблицы с префиксом `photo_`
- Storage bucket: `photos` (не `stickers`)

## Пайплайн генерации (worker)

```
Фото → Gemini API (модель + aspect ratio) → Resize (качество) → PNG → sendPhoto
```

Без background removal, без chroma key.

## Локализация

- Все пользовательские сообщения через `getText(lang, key)`
- Поддерживаемые языки: `ru`, `en`

## База данных (Supabase)

- Та же инстанция что и photo2sticker
- Таблицы с префиксом `photo_` (photo_users, photo_sessions, photo_jobs, photo_results...)
- RPC функции: `claim_job` (пока общая, позже `photo_claim_job`)
