---
description: Business logic for photo generation pipeline
alwaysApply: true
---

# Пайплайн генерации фото

**Всегда читай это правило перед реализацией задач, связанных с генерацией.**

## Flow

```
Фото → Выбор стиля → Выбор модели → Выбор формата → Выбор качества → Gemini → Resize → sendPhoto
```

## Параметры генерации

| Параметр | Хранится в session | Значения |
|----------|-------------------|----------|
| Стиль | `selected_style_id` | Пресеты из `style_presets_v2` |
| Модель | `selected_model` | `gemini-2.5-flash-image`, `gemini-3-pro-image-preview` |
| Формат | `selected_aspect_ratio` | `1:1`, `4:3`, `3:4`, `16:9`, `9:16`, `3:2`, `2:3` |
| Качество | `selected_quality` | `fhd` (1920px), `2k` (2560px), `4k` (3840px) |

## Worker pipeline (worker.ts)

```typescript
// 1. Источник — всегда оригинальное фото
const sourceFileId = session.current_photo_file_id || photos[photos.length - 1];

// 2. Gemini API с aspect ratio
generationConfig: {
  imageConfig: { aspectRatio: selectedAspectRatio }
}

// 3. Resize по качеству
const { width, height } = getOutputDimensions(aspectRatio, quality);
sharp(generatedBuffer).resize(width, height, { fit: "cover" }).png()

// 4. sendPhoto (не sendSticker!)
```

## Отличия от photo2sticker

- НЕТ emotion/motion/text цепочки
- НЕТ удаления фона
- НЕТ WebP / 512x512 / trim / sticker packs
- Результат — PNG фото, не стикер
